<!DOCTYPE html>
<html lang="zh-Hant">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Taipei-Day-Trip</title>
		<meta name="robots" content="index, follow" />
		<base target="_self" />
		<meta name="description" content="台北一日遊網站" />
		<meta name="author" content="Rocky Wu" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
			integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		/>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;700&display=swap"
			rel="stylesheet"
		/>
		<!-- <link
			type="text/css"
			rel="stylesheet"
			href="{{ url_for('static', filename='css/style.css') }}"
		/> -->

		<link rel="stylesheet" href="/static/css/style.css" />
	</head>
	<body>
		<nav>
			<div class="header-nav">
				<h1>台北一日遊</h1>
				<nav>
					<ul>
						<li><a href="#">預定行程</a></li>
						<li><a href="#">登入/註冊</a></li>
					</ul>
				</nav>
			</div>
		</nav>

		<header>
			<div class="header-section">
				<h1>輕鬆享受台北一日悠閒</h1>
				<p>探索每個角落，體驗城市的深度旅遊行程</p>
				<form>
					<input id="clicker" type="search" placeholder="輸入景點名稱查詢" />
					<div id="hidden-div"></div>
					<button id="search">
						<!-- <img
							src="{{ url_for('static', filename='images/icon_search.png') }}"
							alt="search"
              /> -->
						<img
							src="/static/images/icon_search.png"
							alt="search"
							id="img-item"
						/>
					</button>
				</form>
			</div>
		</header>

		<main>
			<section></section>
		</main>
		<footer>
			<p>COPYRIGHT © 2021 台北一日遊</p>
		</footer>
	</body>
	<script>
		let input_categories = document.querySelector("#clicker");
		let hidden = document.querySelector("#hidden-div");
		let form = document.querySelector("form");
		let search_button = document.querySelector("#search");

		const section = document.querySelector("section");
		const footer = document.querySelector("footer");

		function createNawData(arr) {
			arr.forEach((item) => {
				// div-1
				let attractions_item_1 = document.createElement("div");
				attractions_item_1.classList.add("attractions-item-1");

				let img_item_1 = document.createElement("img");
				img_item_1.classList.add("main-imgs");
				img_item_1.src = item["images"][0];

				let p_item_1 = document.createElement("p");
				p_item_1.classList.add("main-name-p");
				p_item_1.innerText = item["name"];

				attractions_item_1.appendChild(img_item_1);
				attractions_item_1.appendChild(p_item_1);
				// div-2
				let attractions_item_2 = document.createElement("div");
				attractions_item_2.classList.add("attractions-item-2");

				let p_left_item_2 = document.createElement("p");
				p_left_item_2.innerText = item["mrt"];
				p_left_item_2.classList.add("p-left");

				let p_right_item_2 = document.createElement("p");
				p_right_item_2.classList.add("p-right");
				p_right_item_2.innerText = item["category"];

				attractions_item_2.appendChild(p_left_item_2);
				attractions_item_2.appendChild(p_right_item_2);

				// main-div
				let main_container = document.createElement("div");
				main_container.classList.add("main-container");

				main_container.appendChild(attractions_item_1);
				main_container.appendChild(attractions_item_2);

				section.appendChild(main_container);
			});
		}

		//////////////////////// first_data ///////////////
		async function get_first_api() {
			let first_data = await fetch("http://35.74.113.149:3000/api/attractions");
			let first_parse_data = await first_data.json();
			let first_data_api = first_parse_data["data"];

			createNawData(first_data_api);

			let categories_data = await fetch(
				"http://35.74.113.149:3000/api/categories"
			);
			let categories_data_api = await categories_data.json();
			let categories_api = categories_data_api["data"];

			categories_api.forEach((item) => {
				// hidden-div-item
				let hidden_div_item = document.createElement("div");
				hidden_div_item.classList.add("hidden-div-item");
				hidden_div_item.innerText = item;

				hidden.appendChild(hidden_div_item);
			});
			let categories_options = document.querySelectorAll(
				"#hidden-div .hidden-div-item"
			);
			window.addEventListener("mouseup", function (event) {
				input_categories.addEventListener("click", (e) => {
					hidden.style = "display: grid;";
				});
				if (!event.target.closest("#clicker")) {
					hidden.style = "display: none;";
				}
			});

			for (let i = 0; i < categories_options.length; i++) {
				categories_options[i].addEventListener("click", (e) => {
					input_categories.value = categories_options[i].innerText;
					input_categories.style = "color : #000000";
				});
			}
		}
		get_first_api();
		///////////////////////////////////////////////

		// ///////////////////////// other_data //////////////////////
		// let currentPage = 1;
		// async function get_other_api() {
		// 	let page = 1;
		// 	let other_pages = await fetch(
		// 		`http://35.74.113.149:3000/api/attractions?page=${currentPage}`
		// 	);

		// 	let other_pages_data = await other_pages.json();
		// 	let { data, nextPage } = other_pages_data;
		// 	createNawData(data);

		// 	//Infinite Scrolling
		// 	let last_api = document.querySelector(".main-container:last-child");

		// 	// defind Listener place
		// 	const opition = {
		// 		root: null,
		// 		rootMargin: "0px 0px 0px 0px",
		// 		threshold: 0,
		// 	};

		// 	// Listener Scrolling
		// 	const observer = new IntersectionObserver((entries) => {
		// 		entries.forEach((entry) => {
		// 			if (entry.isIntersecting) {
		// 				if (nextPage != null) {
		// 					currentPage++;
		// 					get_other_api();
		// 					nextPage = currentPage;
		// 				}
		// 				observer.unobserve(last_api);
		// 			}
		// 		});
		// 	}, opition);

		// 	// defind Listener last api place
		// 	observer.observe(last_api);
		// }
		// get_other_api();
		//////////////////////////////////
		let keyword_page = 0;

		search_button.addEventListener("click", (e) => {
			e.preventDefault();
			const main_container = document.querySelectorAll(".main-container");
			let form = e.target.parentElement;
			let text = form.children[0].value;
			main_container.forEach((e) => {
				e.remove();
			});
			//////////////////////////////
			async function keyword_api() {
				let url = await fetch(
					`http://35.74.113.149:3000/api/attractions?page=${keyword_page}&keyword=${text}`
				);
				let { data, nextPage } = await url.json();
				createNawData(data);

				let last_api = document.querySelector(".main-container:last-child");

				// defind Listener place
				const opition = {
					root: null,
					rootMargin: "0px 0px 0px 0px",
					threshold: 0,
				};
				// Listener Scrolling
				const observer = new IntersectionObserver((entries) => {
					entries.forEach((entry) => {
						if (entry.isIntersecting) {
							if (nextPage != null) {
								keyword_page++;
								keyword_api();
								nextPage = keyword_page;
							}
							observer.unobserve(last_api);
						}
					});
				}, opition);
				// defind Listener last api place
				observer.observe(last_api);
			}
			keyword_api();
		});
		// console.log(text);
	</script>
</html>
<!-- <script src="{{ url_for('static', filename='js/app.js') }}"></script> -->
